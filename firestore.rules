// Reglas MVP: seguras pero prácticas para demo.
// NO usar estas reglas en producción.

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------
    // Usuarios
    // --------------------------
    match /usuarios/{uid} {
      allow read: if request.auth != null;              // un usuario autenticado puede ver cualquier usuario
      allow write: if request.auth != null
                    && request.auth.uid == uid;         // solo puede editarse a sí mismo
    }

    // --------------------------
    // Ligas (lectura pública para demo)
    // --------------------------
    match /ligas/{idLiga} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete:
        if request.auth != null
        && get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'admin';
    }

    // --------------------------
    // Equipos Reales
    // --------------------------
    match /equipos_reales/{idEquipo} {
      allow read: if true;
      allow write:
        if request.auth != null
        && get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'admin';
    }

    // --------------------------
    // Jugadores Reales
    // --------------------------
    match /jugadores_reales/{idJugador} {
      allow read: if true;
      allow write:
        if request.auth != null
        && get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'admin';
    }

    // --------------------------
    // Fechas de Liga
    // --------------------------
    match /fechas_liga/{idFecha} {
      allow read: if true;
      allow write:
        if request.auth != null
        && get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'admin';
    }

    // --------------------------
    // Puntajes Reales por Fecha
    // --------------------------
    match /puntajes_reales/{idPuntaje} {
      allow read: if true;
      allow write:
        if request.auth != null
        && get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'admin';
    }

    // --------------------------
    // Participaciones de usuario en ligas
    // --------------------------
    match /participaciones_liga/{idPart} {

      // LECTURA:
      // - Dueño puede leer su participación.
      // - ADMIN puede leer todas (necesario para aplicar puntajes fantasy).
      allow read:
        if request.auth != null
        && (
            request.auth.uid == resource.data.idUsuario ||
            get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'admin'
          );

      // CREAR:
      // Solo el dueño puede crear su participación
      allow create:
        if request.auth != null
        && request.auth.uid == request.resource.data.idUsuario;

      // UPDATE / DELETE:
      // Dueño o admin pueden actualizar.
      allow update, delete:
        if request.auth != null
        && (
            request.auth.uid == resource.data.idUsuario ||
            get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'admin'
          );

      // SUBCOLECCIÓN: puntajes_fantasy
      match /puntajes_fantasy/{idFecha} {
        allow read, write:
          if request.auth != null
          && (
              request.auth.uid ==
                  get(/databases/$(database)/documents/participaciones_liga/$(idPart)).data.idUsuario ||
              get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'admin'
            );
      }
    }

    // --------------------------
    // Equipos Fantasy
    // --------------------------
    match /equipos_fantasy/{idEq} {

      // LECTURA:
      // - Dueño puede leer su equipo.
      // - ADMIN puede leer todos (necesario para aplicar puntajes fantasy).
      allow read:
        if request.auth != null
        && (
            request.auth.uid == resource.data.idUsuario ||
            get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'admin'
          );

      // CREATE: solo el dueño
      allow create:
        if request.auth != null
        && request.auth.uid == request.resource.data.idUsuario;

      // UPDATE / DELETE:
      // - Dueño o ADMIN pueden escribir
      allow update, delete:
        if request.auth != null
        && (
            request.auth.uid == resource.data.idUsuario ||
            get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'admin'
          );
    }

    // --------------------------
    // Alineaciones Fantasy
    // --------------------------
    match /alineaciones/{idAli} {

      // LECTURA:
      // - Dueño puede leer su alineación
      // - ADMIN puede leer todas (necesario para aplicar puntajes fantasy)
      allow read:
        if request.auth != null
        && (
            request.auth.uid == resource.data.idUsuario ||
            get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'admin'
          );

      // CREATE:
      // Solo el dueño puede crear
      allow create:
        if request.auth != null
        && request.auth.uid == request.resource.data.idUsuario;

      // UPDATE / DELETE:
      // - Dueño o admin pueden editar (admin necesario para recalcular o reparar)
      allow update, delete:
        if request.auth != null
        && (
            request.auth.uid == resource.data.idUsuario ||
            get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'admin'
          );
    }

    // --------------------------
    // Regla por defecto
    // --------------------------
    match /{document=**} {
      allow read: if false;
      allow write: if false;
    }
  }
}
